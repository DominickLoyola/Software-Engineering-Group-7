import requests
import os
import json

# Base URL for local testing
BASE_URL = "http://localhost:5000"

def test_image_analysis():
    """Test image analysis endpoint"""
    # Path to a test image
    test_image = "path/to/test_image.jpg"
    
    if not os.path.exists(test_image):
        print(f"Test image not found: {test_image}")
        return False
    
    # Send request to analyze image
    with open(test_image, 'rb') as f:
        files = {'image': f}
        response = requests.post(f"{BASE_URL}/api/analyze/image", files=files)
    
    # Check response
    if response.status_code == 200:
        result = response.json()
        print("âœ… Image analysis successful!")
        print(f"Result ID: {result.get('result_id')}")
        print(f"Summary: {result.get('summary')}")
        
        # Verify result was saved to disk
        result_id = result.get('result_id')
        verification_response = requests.get(f"{BASE_URL}/api/results/{result_id}")
        
        if verification_response.status_code == 200:
            print("âœ… Result saved to API successfully!")
            return True
        else:
            print("âŒ Failed to verify saved result")
            return False
    else:
        print(f"âŒ Image analysis failed: {response.status_code}")
        print(response.text)
        return False

def test_get_all_results():
    """Test retrieving all results"""
    response = requests.get(f"{BASE_URL}/api/results")
    
    if response.status_code == 200:
        results = response.json().get('results', [])
        print(f"âœ… Retrieved {len(results)} results from API")
        
        # Display most recent results
        for result in results[:3]:
            print(f"- {result.get('timestamp')}: {result.get('summary')}")
        
        return True
    else:
        print(f"âŒ Failed to retrieve results: {response.status_code}")
        print(response.text)
        return False

def main():
    # Start the test suite
    print("ğŸ§ª Running API tests...\n")
    
    # Test the root endpoint to make sure API is running
    try:
        response = requests.get(BASE_URL)
        if response.status_code == 200:
            print("âœ… API is running")
        else:
            print("âŒ API returned unexpected status code")
            return
    except requests.exceptions.ConnectionError:
        print("âŒ API is not running. Please start the server first.")
        return
    
    # Run individual tests
    test_image_analysis()
    test_get_all_results()
    
    print("\nğŸ§ª Tests completed!")

if __name__ == "__main__":
    main()
